<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Simulador de Daltonismo — iOS6 Compatível</title>
  <style type="text/css">
    body { font-family: Helvetica, Arial, sans-serif; margin:0; padding:20px; background:#f7f7fb; color:#111; }
    .card { background:#fff; border-radius:10px; -webkit-border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,.15); padding:15px; max-width:960px; margin:0 auto; }
    h1 { font-size:18px; margin:0 0 8px 0; }
    .muted { color:#555; font-size:12px; }
    .controls { margin-top:12px; }
    .controls div { margin-bottom:10px; }
    label { display:block; font-size:13px; margin-bottom:4px; }
    input[type=range] { width:100%; }
    select, input[type=file], input[type=range], button { font-size:14px; }
    canvas { width:100%; max-width:800px; background:#ddd; margin-top:10px; display:block; }
    .btn { padding:6px 10px; background:#007aff; color:#fff; border:none; border-radius:6px; -webkit-border-radius:6px; cursor:pointer; }
    footer { margin-top:10px; font-size:12px; color:#666; }
    #originalPreview { max-width:100px; border-radius:6px; display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Simulador de Daltonismo (Exemplo)</h1>
    <div class="muted">Carregue uma imagem, escolha o tipo e ajuste a gravidade.</div>

    <div class="controls">
      <div>
        <label for="file">Imagem</label>
        <input id="file" type="file" accept="image/*">
      </div>
      <div>
        <label for="type">Tipo de daltonismo</label>
        <select id="type">
          <option value="normal">Normal</option>
          <option value="protanopia">Protanopia</option>
          <option value="deuteranopia">Deuteranopia</option>
          <option value="tritanopia">Tritanopia</option>
        </select>
      </div>
      <div>
        <label for="severity">Gravidade <span id="sevVal">1.00</span></label>
        <input id="severity" type="range" min="0" max="1" step="0.01" value="1">
      </div>
      <div>
        <button id="download" class="btn">Baixar imagem</button>
      </div>
    </div>

    <canvas id="canvas" width="800" height="600"></canvas>
    <div style="margin-top:8px;">
      <img id="originalPreview" alt="Original">
      <span class="muted">Clique no canvas para ver/ocultar original.</span>
    </div>

    <footer>
      Versão simplificada para compatibilidade com iOS 6 (Safari antigo). Para uso educacional.
    </footer>
  </div>

<script type="text/javascript">
var MATRICES = {
  normal: [ [1,0,0],[0,1,0],[0,0,1] ],
  protanopia: [ [0.567,0.433,0],[0.558,0.442,0],[0,0.242,0.758] ],
  deuteranopia: [ [0.625,0.375,0],[0.7,0.3,0],[0,0.3,0.7] ],
  tritanopia: [ [0.95,0.05,0],[0,0.433,0.567],[0,0.475,0.525] ]
};

var fileInput = document.getElementById('file');
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var typeSelect = document.getElementById('type');
var severity = document.getElementById('severity');
var sevVal = document.getElementById('sevVal');
var downloadBtn = document.getElementById('download');
var originalPreview = document.getElementById('originalPreview');

var img = new Image();
var imgLoaded = false;
var showOriginal = false;

function clamp(v){ return Math.max(0, Math.min(255, v)); }

function applyMatrix(imageData, matrix, mix){
  var d = imageData.data;
  for(var i=0;i<d.length;i+=4){
    var r=d[i], g=d[i+1], b=d[i+2];
    var nr = matrix[0][0]*r + matrix[0][1]*g + matrix[0][2]*b;
    var ng = matrix[1][0]*r + matrix[1][1]*g + matrix[1][2]*b;
    var nb = matrix[2][0]*r + matrix[2][1]*g + matrix[2][2]*b;
    d[i] = clamp((1-mix)*r + mix*nr);
    d[i+1] = clamp((1-mix)*g + mix*ng);
    d[i+2] = clamp((1-mix)*b + mix*nb);
  }
}

function render(){
  if(!imgLoaded) return;
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  var data = ctx.getImageData(0,0,canvas.width,canvas.height);
  var type = typeSelect.value;
  var matrix = MATRICES[type] || MATRICES.normal;
  var mix = parseFloat(severity.value);
  if(type!=='normal' && mix>0){
    applyMatrix(data, matrix, mix);
    ctx.putImageData(data,0,0);
  }
}

fileInput.onchange = function(){
  var f = fileInput.files[0];
  if(!f) return;
  var url = window.URL ? URL.createObjectURL(f) : window.webkitURL.createObjectURL(f);
  img.onload = function(){
    imgLoaded = true;
    canvas.width = img.width > 800 ? 800 : img.width;
    canvas.height = img.height * (canvas.width/img.width);
    originalPreview.src = url;
    originalPreview.style.display = 'inline';
    render();
  };
  img.src = url;
};

typeSelect.onchange = severity.oninput = function(){
  sevVal.innerHTML = parseFloat(severity.value).toFixed(2);
  render();
};

downloadBtn.onclick = function(){
  if(!imgLoaded){ alert('Carregue uma imagem primeiro.'); return; }
  var link = document.createElement('a');
  link.href = canvas.toDataURL('image/png');
  link.download = 'simulacao.png';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

canvas.onclick = function(){
  if(!imgLoaded) return;
  showOriginal = !showOriginal;
  if(showOriginal){
    ctx.drawImage(originalPreview,0,0,canvas.width,canvas.height);
  } else {
    render();
  }
};
</script>
</body>
</html>
